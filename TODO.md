# esgo2dump ?????? TODO

## ????

**esgo2dump** ???? Go ????? Elasticsearch ????/??????? elasticdump ??????

### ????
- ? ????/???ES ? ES?ES ? File?
- ? ?? Elasticsearch 6 ? 7
- ? Mapping ??/??
- ? Setting ??/??
- ? ???????`--query` ? `--query_file`?
- ? ???????`--field`?
- ? ?????`--sort`?
- ? ????? ES ??
- ? ???????? mapping?

---

## Roadmap??? README?

### ??? ?
- [x] data dump
- [x] mapping dump
- [x] es to file
- [x] es to es
- [x] auto create index with mapping
- [x] support es6

### ??? ?
- [ ] [Feature Request #1](https://github.com/loveuer/esgo2dump/issues/1): Supports more than 10,000 lines of query_file
- [ ] args: split_size (auto split json output file)
- [ ] auto create index with mapping,setting
- [ ] support es8

---

## ????????????

### 1. ?????????/???

#### 1.1 ES8 ?????
**??**: `internal/core/io.go:67-68`
```go
case "8":
    // ???????? ES8 ?????
```
**??**: ???? ES8 ??
**??**: 
- ?? `xes/es8/client.go` ?????
- ?? ES7 ?????

#### 1.2 ?????????????
**??**: `internal/xfile/xfile.go:44`
```go
if len(fields) > 0 {
    // todo: pick fields
}
```
**??**: ????????`--field` ????
**??**: ????????????????

#### 1.3 Query File ?? 10,000 ???
**??**: `internal/cmd/root.run.go:33-35`
```go
if opt.Cfg.Args.Limit == 0 || opt.Cfg.Args.Limit > 10000 {
    return fmt.Errorf("invalid limit(1 - 10000)")
}
```
**??**: ???? limit ????? query_file ???????????
**??**: 
- ???????????????????
- ???? goroutine pool ????????

### 2. ?????????/?????

#### 2.1 ???????
**??**: ??
**??**:
- `internal/core/run.data.go:38-44` ?? `os.Exit(1)` ??????
- ????????????
**??**: 
- ????????
- ?? context ????????
- ??????????

#### 2.2 ?????? ? ???
**??**: `internal/core/run.data.go:106`
```go
if qf, err = os.Open(opt.Cfg.Args.QueryFile); err != nil {
    return err
}
// ?? defer qf.Close()
```
**??**: 
- ? ??? `defer qf.Close()` ????????
- ? ??? `scanner.Err()` ?????????

#### 2.3 ???????
**??**: ??
**??**:
- Scroll ?????? 35 ? (`xes/es7/read.go:65`)
- ???????
- Buffer ??? `opt/var.go` ???????????
**??**: 
- ????????????
- ????????

#### 2.4 ??????
**??**: `internal/core/run.data.go`
**??**:
- `total` ??? goroutine ?????????????????? goroutine ???
- ?????????????????
**??**: ?? `sync/atomic` ? `sync.Mutex` ??????

#### 2.5 ??????
**??**: ????????????????
**??**: 
- ???????????? `github.com/jedib0t/go-pretty/v6`?
- ?????/??????????????

#### 2.6 ????????
**??**: `internal/xfile/xfile.go:57-77`
**??**: 
- ??? NDJSON????? JSON?????????
- ???????gzip?
**??**: 
- ?? `--format` ???ndjson/json?
- ?? `--compress` ???? gzip ??

### 3. ?????????/?????

#### 3.1 ????
**??**: ES6 ? ES7 ??????????
**??**: 
- ???????????
- ???????Go 1.18+?????

#### 3.2 ??????
**??**: ????
**??**: ?? `xes/es7/client_test.go`???????????
**??**: 
- ???????????
- ??????
- ?? mock ES ???????

#### 3.3 ?????
**??**: 
- README ????????
- ?? API ??
- ????????
**??**: 
- ?? README?????????
- ?? `--help` ?????
- ???????FAQ???

#### 3.4 ??????
**??**: `internal/opt/var.go:15`
```go
Version = "vx.x.x"
```
**??**: 
- ???????????`-ldflags`?
- ?? git tag ??

#### 3.5 ??????
**??**: `internal/cmd/root.run.go:preRun`
**??**: 
- ???????????? URI ????????
- ????????????????????????
**??**: ??????????

#### 3.6 ??????
**??**: `pkg/log/`
**??**: ?? Debug ???????? Info?Warn?Error ???
**??**: ??????????????????

### 4. ??????

#### 4.1 ????????
**??**: `--split_size` ???????????????????
**????**: 
- ?????????????????
- ??????`output.json.1`, `output.json.2`, ...

#### 4.2 ????????? Setting
**??**: ?? mapping ????? setting
**????**: 
- ?? `RunMapping` ?????? setting
- ??? `--with-setting` ??

#### 4.3 ????
**??**: ?????????
**????**: 
- ???????
- ?? `--resume` ??

#### 4.4 ??????
**??**: `xes/es7/write.go:151-174`
**??**: BulkIndexer ????????
**??**: 
- ????????? `NumWorkers`
- ?? `--batch-size` ??
- ?? `FlushBytes` ? `FlushInterval`

#### 4.5 ????
**??**: 
- ?????????????????
- ?? `--stats` ????????

#### 4.6 ????????
**??**: 
- CSV ????
- ?????????

---

## ????????

### 1. ????
- ????????? `fmt.Errorf` ? `errors.Wrap`
- ?????????????
- ?????????recover?

### 2. ????
- ??? ES ???????????
- ?????????
- ????????

### 3. ????
- ??????? GC ??
- ?? JSON ???????? `jsoniter`?
- ???????

### 4. ???
- ?? TLS ??????? `InsecureSkipVerify: true`?
- ????????????????
- ?????????????

---

## ????

### ????
- [ ] `internal/core/run.data.go` - ??????
- [ ] `internal/core/io.go` - IO ????
- [ ] `internal/xfile/xfile.go` - ?? IO
- [ ] `xes/es7/read.go` - ES7 ??
- [ ] `xes/es7/write.go` - ES7 ??

### ????
- [ ] ES6 ? ES7 ????
- [ ] ES ?????/??
- [ ] ??????>1GB?
- [ ] ???????>10,000 ??

### ????
- [ ] ??????????
- [ ] ????????
- [ ] ????????

---

## ????

### ????
- `github.com/elastic/go-elasticsearch/v6` - ES6 ???
- `github.com/elastic/go-elasticsearch/v7` - ES7 ???
- `github.com/spf13/cobra` - CLI ??
- `github.com/go-resty/resty/v2` - HTTP ???
- `github.com/jedib0t/go-pretty/v6` - ????
- `github.com/samber/lo` - ??????

### ??
- ?????????????
- ??????????
- ?????????? `nancy`?

---

## ??

### ?????????
1. ? ES8 ???????????????
2. ? ????????????
3. ? Query file ???????? defer close?

### ?????1-2 ??
1. ??????
2. ??????
3. ??????
4. ?? split_size ??

### ?????1-2 ??
1. ?? ES8
2. ??????
3. ????
4. ????

---

**????**: 2024????????
**???**: AI Assistant
